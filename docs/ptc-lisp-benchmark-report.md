# PTC-Lisp Phase 1 Benchmark Report

**Date:** 2024-12-08 (Updated)
**Status:** PASS

## Executive Summary

After two benchmark runs, LLMs achieved **92.4% syntax validity** with an improved judge, meeting the >90% target. The improved judge prompt and edge case scenarios successfully caught errors that were previously missed. PTC-Lisp syntax is LLM-friendly and can be reliably generated by modern LLMs.

## Test Configuration

### Run 2 (2024-12-08) — Improved Judge + Edge Cases

| Parameter | Value |
|-----------|-------|
| Generator Models | gemini-2.5-flash, deepseek-v3.2 |
| Judge Model | gpt-5.1-codex-mini |
| Scenarios | 11 (8 original + 3 edge cases) |
| Iterations per scenario | 3 |
| Total generations | 66 |

### Run 1 (2024-12-07) — Baseline

| Parameter | Value |
|-----------|-------|
| Generator Models | gemini-2.5-flash, deepseek-v3.2 |
| Judge Model | claude-3.5-haiku |
| Scenarios | 8 |
| Iterations per scenario | 3 |
| Total generations | 48 |

## Results Summary

### Run 2 Results (Improved)

| Model | Valid | Rate | Cost |
|-------|-------|------|------|
| gemini-2.5-flash | 29/33 | **87.9%** | $0.153 |
| deepseek-v3.2 | 32/33 | **97.0%** | $0.149 |
| **Combined** | **61/66** | **92.4%** | $0.302 |

### Run 1 Results (Manual Review)

| Model | Reported | Actual (manual review) |
|-------|----------|------------------------|
| gemini-2.5-flash | 100% (24/24) | ~92% (~22/24) |
| deepseek-v3.2 | 100% (24/24) | ~88% (~21/24) |

## Results by Difficulty Level (Run 2)

| Level | Description | gemini-2.5-flash | deepseek-v3.2 |
|-------|-------------|------------------|---------------|
| L1 | Simple filter/count | 6/6 ✓ | 6/6 ✓ |
| L2 | Pipelines, aggregates | 6/6 ✓ | 5/6 |
| L3 | Predicate combinators, conditionals | 2/6 | 6/6 ✓ |
| L4 | Tool calls, memory contract | 6/6 ✓ | 6/6 ✓ |
| L5 | Edge cases | 9/9 ✓ | 9/9 ✓ |

## Test Scenarios

### Level 1 (Simple)
- **simple_filter**: Filter items by price > 100
- **simple_count**: Count active users

### Level 2 (Pipeline)
- **pipeline_filter_sort**: Filter employees by salary, sort descending, take top 5
- **aggregate_sum**: Sum amounts for completed orders

### Level 3 (Predicates)
- **predicate_combinator**: Filter products using `any-of` and `none-of` combinators
- **conditional_logic**: Categorize orders by amount using `cond`

### Level 4 (Tool + Memory)
- **tool_call_transform**: Call tool, filter results, extract field
- **memory_contract**: Store results in memory with `:result` key

### Level 5 (Edge Cases) — New in Run 2
- **edge_truthy_check**: Filter active users (tests for missing `=` operator)
- **edge_range_check**: Filter by price range (tests for 3-arity comparison)
- **edge_multi_field_extract**: Extract fields from maps (tests for fn destructuring)

## Errors Found (Run 2)

### Gemini (4 errors)

**predicate_combinator #2** — Used anonymous function shorthand:
```clojure
(map #(select-keys % [:name :price]) ...)
```
Error: `#(...)` shorthand not supported, use `(fn [x] ...)`.

**conditional_logic #1-3** — All 3 iterations used 3-arity comparison:
```clojure
(<= 100 amount 500)
```
Error: PTC-Lisp only supports 2-arity comparisons.

### DeepSeek (1 error)

**aggregate_sum #2** — Used Elixir-style pipe:
```clojure
(filter (where :status = "completed") ctx/orders) |> sum-by :amount
```
Error: Use `->>` threading macro, not `|>`.

## Sample Outputs (Run 2)

### simple_filter (gemini-2.5-flash)
```clojure
(filter (where :price > 100) ctx/products)
```

### edge_range_check (deepseek-v3.2) ✓
```clojure
(filter (all-of (where :price >= 100) (where :price <= 500)) ctx/products)
```

### conditional_logic (deepseek-v3.2) ✓
```clojure
(map (fn [order]
       (let [amount (:amount order)
             size (cond
                    (< amount 100) "small"
                    (<= amount 500) "medium"
                    :else "large")]
         {:id (:id order) :size size}))
     ctx/orders)
```

### edge_multi_field_extract (deepseek-v3.2) ✓
```clojure
(->> ctx/orders (map (fn [order] (let [{:keys [id name]} order] {:id id :name name}))))
```

## Key Findings

### 1. Improved Judge Effectiveness

The enhanced judge prompt with explicit invalid patterns caught:
- 3-arity comparisons `(<= 100 x 500)`
- Anonymous function shorthand `#(...)`
- Elixir-style pipe operator `|>`

### 2. Edge Case Scenarios Successful

All 18 edge case tests passed (9/9 for each model):
- Both models used `(where :active = true)` correctly
- Both models used `(all-of (where :price >= 100) (where :price <= 500))` for ranges
- Both models avoided fn parameter destructuring

### 3. Model Comparison

| Aspect | Gemini | DeepSeek |
|--------|--------|----------|
| Overall accuracy | 87.9% | 97.0% |
| 3-arity mistake | Yes (3x) | No |
| Pipe operator mistake | No | Yes (1x) |
| Edge cases | Perfect | Perfect |

### 4. Prompt Improvements Applied

After Run 2, the generator prompt was updated to include:
- Explicit 3-arity comparison in "Common Mistakes" table
- Key constraint: "Comparisons are strictly 2-arity"

## Conclusion

PTC-Lisp syntax is **LLM-friendly**. With proper guidance in the prompt:
- DeepSeek achieves 97% validity
- Gemini achieves 88% validity (struggles with range comparisons)
- Combined rate of 92.4% exceeds the 90% target

### Recommendations

1. ✅ **Improved judge prompt** — Added explicit invalid patterns (completed)
2. ✅ **Added edge case scenarios** — L5 tests for common mistakes (completed)
3. ✅ **Updated generator prompt** — Added 2-arity comparison constraint (completed)
4. **Consider model selection** — DeepSeek outperforms Gemini for PTC-Lisp generation

### Final Recommendation

**Proceed with PTC-Lisp implementation.** Phase 1 evaluation criteria met.

## Files

- Benchmark script: `test/support/ptc_lisp_benchmark.ex`
- Run 2 results: `priv/ptc_lisp_benchmark/20251208T094936/`
- Run 1 results: `priv/ptc_lisp_benchmark/20251207T092329/`
