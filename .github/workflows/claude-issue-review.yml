name: Claude Issue Review

on:
  issues:
    types: [labeled]

jobs:
  claude-issue-review:
    # Only run when 'needs-review' label is added
    if: github.event.label.name == 'needs-review'
    runs-on: ubuntu-latest

    # Prevent concurrent Claude operations on the same issue
    # Uses same group as claude-issue.yml to prevent duplicate work
    concurrency:
      group: claude-issue-${{ github.event.issue.number }}
      cancel-in-progress: false

    permissions:
      contents: read
      issues: write
      id-token: write
    env:
      MIX_ENV: test

    steps:
      - name: Check PAT availability
        run: |
          if [ -z "${{ secrets.PAT_WORKFLOW_TRIGGER }}" ]; then
            echo "::warning::PAT_WORKFLOW_TRIGGER secret not set - @claude trigger won't work"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Setup Claude Code
        uses: ./.github/actions/setup-claude-code

      - name: Run Claude Issue Review
        uses: anthropics/claude-code-action@v1
        env:
          # Use PAT so that adding ready-for-implementation label triggers PM workflow
          # Falls back to github.token if PAT not available (but PM trigger won't work)
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
        with:
          path_to_claude_code_executable: ~/.local/bin/claude
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            ISSUE NUMBER: ${{ github.event.issue.number }}
            ISSUE TITLE: ${{ github.event.issue.title }}

            Review this GitHub issue using the project's planning guidelines:

            1. Read `docs/guidelines/planning-guidelines.md` for the pre-review checks and 9-point review checklist
            2. Use `gh issue view ${{ github.event.issue.number }} --comments` to read the full issue and all comments
            3. Explore the codebase to verify proposed solutions work with existing code
            4. Follow the output format from the planning guidelines (including Pre-Review Checks section)

            After your review:

            1. **Always update the issue body** with improvements you identify:
               - Fix unclear descriptions, add missing context
               - Add edge cases, test scenarios, or acceptance criteria
               - Correct technical inaccuracies based on codebase exploration
               - Structure the issue better (add sections if missing)
               - To update: write to /tmp/issue-body.md, then run:
                 `gh issue edit ${{ github.event.issue.number }} --body-file /tmp/issue-body.md`

            2. **Post a review comment** summarizing:
               - What you found and changed in the issue body
               - Any remaining concerns or questions
               - Your recommendation (ready, needs-clarification, or needs-breakdown)

            3. **Add appropriate labels** using `gh issue edit --add-label`:
               - `ready-for-implementation` if issue is well-defined and ready
               - `needs-clarification` if important details are missing (and you couldn't fill them in)
               - `needs-breakdown` if issue should be split into smaller issues
               - `bug` / `enhancement` / `documentation` based on issue type

            4. **If approved (added `ready-for-implementation`)**, trigger implementation:
               - First check no implementation is running:
                 `gh run list --workflow=claude-issue.yml --status=in_progress --json databaseId --jq 'length'`
               - If result is 0, post trigger: `gh issue comment ${{ github.event.issue.number }} --body "@claude Please implement this issue. Read the linked spec documents for context."`
               - If result is > 0, skip trigger (another implementation is running)

          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "Read,Write,Edit,MultiEdit,Glob,Grep,LS,Bash,WebSearch,WebFetch,Task,TodoWrite,TodoRead"'
