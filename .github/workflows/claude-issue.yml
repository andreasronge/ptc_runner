name: Claude Issue Implementation

on:
  issue_comment:
    types: [created]

jobs:
  claude:
    # Trigger on @claude mentions in issue comments (not PRs)
    # Security: requires ready-for-implementation label OR repo owner
    if: |
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '@claude') &&
      (
        github.actor == 'andreasronge' ||
        contains(toJSON(github.event.issue.labels), 'ready-for-implementation')
      )
    runs-on: ubuntu-latest

    concurrency:
      group: claude-issue-${{ github.event.issue.number }}
      cancel-in-progress: false

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    env:
      MIX_ENV: test

    steps:
      - name: Check PAT availability
        run: |
          if [ -z "${{ secrets.PAT_WORKFLOW_TRIGGER }}" ]; then
            echo "::warning::PAT_WORKFLOW_TRIGGER secret not set - PRs won't trigger CI automatically"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}

      - name: Install git pre-commit hook
        run: |
          cp scripts/pre-commit .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
          # Used by E2E tests that call LLM APIs
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            Implement issue #${{ github.event.issue.number }}.

            Read the issue and comments: `gh issue view ${{ github.event.issue.number }} --comments`

            **Guidelines:**
            - Keep it simple - only implement what's requested
            - Run `mix precommit` before committing - NEVER use `--no-verify`
            - If tests fail, fix them or use the escape hatch - don't bypass
            - Create PR with "Closes #${{ github.event.issue.number }}" in body

            **Escape hatch:** If you discover unexpected complexity, required refactoring, bugs, or other work that should be handled separately - create a new issue for it. Then either continue with reduced scope, or if it's a blocker: remove the `ready-for-implementation` label, post a comment explaining why, and stop.

            NEVER include "@claude" in comments.

          claude_args: '--model claude-sonnet-4-5-20250929 --max-turns 150 --allowed-tools "Read,Write,Edit,MultiEdit,Glob,Grep,LS,Bash,WebSearch,WebFetch,Task,TodoWrite,TodoRead"'
          show_full_output: true

      # Safety net: push any unpushed commits and remove workflow files
      - name: Push unpushed commits
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
        run: |
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          [ "$CURRENT_BRANCH" = "main" ] && exit 0

          # Re-configure git auth (Claude may have changed it)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"

          # Remove workflow files from any unpushed commits (GitHub App tokens can't push these)
          if git log origin/main..HEAD --name-only --pretty=format: 2>/dev/null | grep -q "^\.github/workflows/"; then
            echo "Removing workflow files from commit..."
            COMMIT_MSG=$(git log -1 --format=%s)
            git reset HEAD~1 --soft
            git checkout origin/main -- .github/workflows/ 2>/dev/null || true
            git add -A
            git reset HEAD -- .github/workflows/ 2>/dev/null || true
            git commit -m "$COMMIT_MSG" 2>/dev/null || echo "No changes after removing workflow files"
          fi

          # Push if there are unpushed commits
          if git log origin/main..HEAD --oneline 2>/dev/null | grep -q .; then
            echo "Pushing unpushed commits..."
            git push -u origin HEAD
            echo "::notice::Pushed commits"
          fi
