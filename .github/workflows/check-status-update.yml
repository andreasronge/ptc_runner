name: Check STATUS.md Update

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  check-status:
    # Only run on implementation PRs (not status-only PRs or other chore PRs)
    # Implementation PRs typically reference an issue or have specific patterns
    if: |
      !startsWith(github.event.pull_request.title, 'chore: update PM status') &&
      !contains(github.event.pull_request.title, '[skip status check]')

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if STATUS.md was modified
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get list of changed files in this PR
          CHANGED_FILES=$(gh pr view ${{ github.event.pull_request.number }} --json files --jq '.files[].path')

          echo "Changed files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "^STATUS.md$"; then
            echo "status_updated=true" >> $GITHUB_OUTPUT
            echo "✅ STATUS.md was updated in this PR"
          else
            echo "status_updated=false" >> $GITHUB_OUTPUT
            echo "❌ STATUS.md was NOT updated in this PR"
          fi

      - name: Check if reminder already posted
        if: steps.check.outputs.status_updated == 'false'
        id: reminder
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if we already posted a reminder comment
          EXISTING=$(gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[].body' | grep -c "STATUS.md was not updated" || true)

          if [ "$EXISTING" -gt 0 ]; then
            echo "already_reminded=true" >> $GITHUB_OUTPUT
            echo "Reminder already posted, skipping"
          else
            echo "already_reminded=false" >> $GITHUB_OUTPUT
          fi

      - name: Post reminder comment
        if: steps.check.outputs.status_updated == 'false' && steps.reminder.outputs.already_reminded == 'false'
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "@claude STATUS.md was not updated in this PR.

          Please update STATUS.md to reflect this work:
          - Set 'Current work' to the issue this PR implements
          - Add a row to the 'Recent Activity' table with today's date
          - Update the 'Last updated' timestamp

          Then push the changes to this PR branch."

      - name: Fail if STATUS.md not updated
        if: steps.check.outputs.status_updated == 'false'
        run: |
          echo "::error::STATUS.md must be updated in implementation PRs"
          echo "A @claude comment has been posted to request the update."
          exit 1
