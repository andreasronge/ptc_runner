name: Benchmark Tests

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'LLM Provider'
        required: false
        type: choice
        options:
          - openrouter
          - bedrock
        default: 'openrouter'
      dsl:
        description: 'Which DSL to test'
        required: false
        type: choice
        options:
          - lisp
          - json
          - both
        default: 'lisp'
      runs:
        description: 'Number of test runs per model'
        required: false
        type: number
        default: 1
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false
      debug_parser:
        description: 'Debug unidentified parse errors'
        required: false
        type: boolean
        default: false

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

jobs:
  benchmark:
    runs-on: ubuntu-latest
    name: Benchmark ${{ matrix.model }} (${{ inputs.provider }})
    strategy:
      fail-fast: true
      matrix:
        model: [deepseek, gemini, haiku]
        exclude:
          # Exclude models not available on bedrock
          - model: ${{ inputs.provider == 'bedrock' && 'deepseek' || 'never-exclude' }}
          - model: ${{ inputs.provider == 'bedrock' && 'gemini' || 'never-exclude' }}
    env:
      MIX_ENV: dev
      OPENROUTER_API_KEY: ${{ inputs.provider == 'openrouter' && secrets.OPENROUTER_API_KEY || '' }}
      PTC_DEBUG_PARSER: ${{ inputs.debug_parser && '1' || '' }}
      LLM_DEFAULT_PROVIDER: ${{ inputs.provider }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Configure AWS credentials for Bedrock (OIDC - no secrets needed)
      - name: Configure AWS credentials
        if: inputs.provider == 'bedrock'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::987540640537:role/GitHubActionsBedrockRole
          aws-region: us-east-1

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Install demo dependencies
        working-directory: demo
        run: mix deps.get

      - name: Compile demo
        working-directory: demo
        run: mix compile

      - name: Run Lisp benchmark
        if: inputs.dsl == 'lisp' || inputs.dsl == 'both'
        working-directory: demo
        run: |
          mix lisp --test \
            --model=${{ inputs.provider }}:${{ matrix.model }} \
            --runs=${{ inputs.runs }} \
            --validate-clojure \
            ${{ inputs.verbose && '--verbose' || '' }} \
            --report
        timeout-minutes: 30

      - name: Run JSON benchmark
        if: inputs.dsl == 'json' || inputs.dsl == 'both'
        working-directory: demo
        run: |
          mix json --test \
            --model=${{ inputs.provider }}:${{ matrix.model }} \
            --runs=${{ inputs.runs }} \
            ${{ inputs.verbose && '--verbose' || '' }} \
            --report
        timeout-minutes: 30

      - name: Generate job summary
        if: always()
        working-directory: demo
        run: |
          echo "## Benchmark Results: ${{ matrix.model }} (${{ inputs.provider }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for report in reports/*.md; do
            if [ -f "$report" ]; then
              echo "### $(basename "$report")" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cat "$report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "---" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-reports-${{ matrix.model }}-${{ inputs.provider }}
          path: demo/reports/
          if-no-files-found: warn
          retention-days: 30

  aggregate:
    runs-on: ubuntu-latest
    needs: benchmark
    if: always()
    name: Aggregate Reports

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: benchmark-reports-*
          path: all-reports
          merge-multiple: true

      - name: Install demo dependencies
        working-directory: demo
        run: mix deps.get

      - name: Compile demo
        working-directory: demo
        run: mix compile

      - name: Generate aggregate report
        working-directory: demo
        run: |
          mix aggregate ../all-reports --output ../all-reports/SUMMARY.md

      - name: Add summary to GitHub Actions
        run: |
          if [ -f "all-reports/SUMMARY.md" ]; then
            cat all-reports/SUMMARY.md >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Individual Reports" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for report in all-reports/*.md; do
            if [ -f "$report" ] && [ "$(basename "$report")" != "SUMMARY.md" ]; then
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              echo "<summary>$(basename "$report")</summary>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              cat "$report" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Upload combined reports
        uses: actions/upload-artifact@v4
        with:
          name: all-benchmark-reports
          path: all-reports/
          if-no-files-found: warn
          retention-days: 30
