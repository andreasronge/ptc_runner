name: Claude Epic Update

on:
  issues:
    types: [closed]

jobs:
  update-epic:
    # Only run when an issue with an epic label is closed
    if: |
      github.event.issue.state == 'closed' &&
      contains(toJSON(github.event.issue.labels), 'epic:')

    runs-on: ubuntu-latest

    concurrency:
      group: claude-automation
      cancel-in-progress: false

    permissions:
      issues: write

    steps:
      - name: Find and update epic
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "Issue #$ISSUE_NUMBER closed, updating epic..."

          # Extract epic label (e.g., "epic:message-history" -> find epic with that label)
          EPIC_LABEL=$(echo '${{ toJSON(github.event.issue.labels) }}' | jq -r '.[] | select(.name | startswith("epic:")) | .name' | head -1)

          if [ -z "$EPIC_LABEL" ]; then
            echo "No epic label found, skipping"
            exit 0
          fi

          echo "Found epic label: $EPIC_LABEL"

          # Find the active epic with matching label
          EPIC_NUMBER=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "type:epic" \
            --label "status:active" \
            --state open \
            --json number,body \
            --jq '.[0].number')

          if [ -z "$EPIC_NUMBER" ] || [ "$EPIC_NUMBER" = "null" ]; then
            echo "No active epic found, skipping"
            exit 0
          fi

          echo "Found active epic: #$EPIC_NUMBER"

          # Get epic body
          EPIC_BODY=$(gh issue view "$EPIC_NUMBER" --repo "${{ github.repository }}" --json body --jq '.body')

          # Check if the issue is referenced in the epic (as checkbox)
          if echo "$EPIC_BODY" | grep -q "\- \[ \] #$ISSUE_NUMBER"; then
            echo "Found unchecked reference to #$ISSUE_NUMBER, checking it off..."

            # Replace unchecked with checked
            NEW_BODY=$(echo "$EPIC_BODY" | sed "s/- \[ \] #$ISSUE_NUMBER/- [x] #$ISSUE_NUMBER/g")

            # Update the epic
            echo "$NEW_BODY" > /tmp/epic-body.md
            gh issue edit "$EPIC_NUMBER" --repo "${{ github.repository }}" --body-file /tmp/epic-body.md

            echo "âœ… Updated epic #$EPIC_NUMBER - checked off #$ISSUE_NUMBER"
          else
            echo "Issue #$ISSUE_NUMBER not found as unchecked item in epic, skipping"
          fi
