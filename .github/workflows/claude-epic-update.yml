name: Claude Epic Update

on:
  issues:
    types: [closed]

jobs:
  update-epic:
    # Only run when an issue with an epic label is closed
    if: |
      github.event.issue.state == 'closed' &&
      contains(toJSON(github.event.issue.labels), 'epic:')

    runs-on: ubuntu-latest

    concurrency:
      group: claude-automation
      cancel-in-progress: false

    permissions:
      issues: write
      actions: read

    steps:
      - name: Update epic and trigger next issue
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
          CLOSED_ISSUE: ${{ github.event.issue.number }}
        run: |
          echo "Issue #$CLOSED_ISSUE closed, updating epic..."

          # Find the active epic
          EPIC_NUMBER=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "type:epic" \
            --label "status:active" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -z "$EPIC_NUMBER" ] || [ "$EPIC_NUMBER" = "null" ]; then
            echo "No active epic found, skipping"
            exit 0
          fi

          echo "Found active epic: #$EPIC_NUMBER"

          # Get epic body
          EPIC_BODY=$(gh issue view "$EPIC_NUMBER" --repo "${{ github.repository }}" --json body --jq '.body')

          # Check off the completed issue
          if echo "$EPIC_BODY" | grep -q "\- \[ \] #$CLOSED_ISSUE"; then
            echo "Checking off #$CLOSED_ISSUE in epic..."
            NEW_BODY=$(echo "$EPIC_BODY" | sed "s/- \[ \] #$CLOSED_ISSUE/- [x] #$CLOSED_ISSUE/g")
            echo "$NEW_BODY" > /tmp/epic-body.md
            gh issue edit "$EPIC_NUMBER" --repo "${{ github.repository }}" --body-file /tmp/epic-body.md
            echo "✅ Checked off #$CLOSED_ISSUE"

            # Re-read the updated body
            EPIC_BODY="$NEW_BODY"
          fi

          # Find first incomplete phase and its unchecked issues
          echo ""
          echo "=== Analyzing phase structure ==="

          # Extract phases and find first with unchecked items
          CURRENT_PHASE=""
          PHASE_ISSUES=""

          while IFS= read -r line; do
            # Check for phase header
            if echo "$line" | grep -qE "^### Phase [0-9]+"; then
              PHASE_NAME=$(echo "$line" | sed 's/### //')
              # If we already found unchecked issues in a previous phase, stop
              if [ -n "$PHASE_ISSUES" ]; then
                break
              fi
              CURRENT_PHASE="$PHASE_NAME"
              PHASE_ISSUES=""
            fi

            # Check for unchecked issue in current phase
            if [ -n "$CURRENT_PHASE" ] && echo "$line" | grep -qE "^- \[ \] #[0-9]+"; then
              ISSUE_NUM=$(echo "$line" | grep -oE "#[0-9]+" | head -1 | tr -d '#')
              PHASE_ISSUES="$PHASE_ISSUES $ISSUE_NUM"
            fi
          done <<< "$EPIC_BODY"

          if [ -z "$PHASE_ISSUES" ]; then
            echo "No incomplete phases found - epic may be complete!"
            exit 0
          fi

          echo "First incomplete phase: $CURRENT_PHASE"
          echo "Unchecked issues:$PHASE_ISSUES"

          # Check if there's already a running/queued workflow
          echo ""
          echo "=== Checking for running workflows ==="
          RUNNING_WORKFLOWS=$(gh run list \
            --repo "${{ github.repository }}" \
            --status in_progress \
            --json name,status \
            --jq '[.[] | select(.name | test("Issue Review|Issue Implementation"))] | length')

          QUEUED_WORKFLOWS=$(gh run list \
            --repo "${{ github.repository }}" \
            --status queued \
            --json name,status \
            --jq '[.[] | select(.name | test("Issue Review|Issue Implementation"))] | length')

          PENDING_WORKFLOWS=$(gh run list \
            --repo "${{ github.repository }}" \
            --status pending \
            --json name,status \
            --jq '[.[] | select(.name | test("Issue Review|Issue Implementation"))] | length')

          TOTAL_ACTIVE=$((RUNNING_WORKFLOWS + QUEUED_WORKFLOWS + PENDING_WORKFLOWS))
          echo "Active workflows: $TOTAL_ACTIVE (running: $RUNNING_WORKFLOWS, queued: $QUEUED_WORKFLOWS, pending: $PENDING_WORKFLOWS)"

          if [ "$TOTAL_ACTIVE" -gt 0 ]; then
            echo "Workflows already active, not triggering new issues"
            exit 0
          fi

          # Find ONE issue to trigger (first unblocked one)
          echo ""
          echo "=== Finding next issue to trigger ==="

          for ISSUE_NUM in $PHASE_ISSUES; do
            echo ""
            echo "--- Checking #$ISSUE_NUM ---"

            # Get issue details
            ISSUE_DATA=$(gh issue view "$ISSUE_NUM" --repo "${{ github.repository }}" --json state,labels,body)
            ISSUE_STATE=$(echo "$ISSUE_DATA" | jq -r '.state')
            ISSUE_LABELS=$(echo "$ISSUE_DATA" | jq -r '.labels[].name' | tr '\n' ' ')
            ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')

            # Skip if already closed
            if [ "$ISSUE_STATE" = "CLOSED" ]; then
              echo "  Already closed, skipping"
              continue
            fi

            # Check blockers - extract from "Blocked by:" section, stop at "Blocks:" or other sections
            # Handles both inline (Blocked by: #1, #2) and multiline (Blocked by:\n- #1\n- #2)
            BLOCKED_SECTION=$(echo "$ISSUE_BODY" | sed -n '/[Bb]locked [Bb]y:/,/\*\*[Bb]locks\|^##\|^$/p' | grep -v "^\*\*[Bb]locks" | head -10 || true)
            ALL_RESOLVED=true

            if [ -n "$BLOCKED_SECTION" ]; then
              BLOCKERS=$(echo "$BLOCKED_SECTION" | grep -oE "#[0-9]+" | tr -d '#' | sort -u)

              for BLOCKER in $BLOCKERS; do
                # Skip self-references (issue blocking itself is invalid)
                if [ "$BLOCKER" = "$ISSUE_NUM" ]; then
                  echo "  WARNING: Issue #$ISSUE_NUM references itself as blocker - ignoring"
                  continue
                fi

                BLOCKER_STATE=$(gh issue view "$BLOCKER" --repo "${{ github.repository }}" --json state --jq '.state' 2>/dev/null || echo "UNKNOWN")
                if [ "$BLOCKER_STATE" != "CLOSED" ]; then
                  echo "  Still blocked by #$BLOCKER ($BLOCKER_STATE)"
                  ALL_RESOLVED=false
                  break
                fi
              done
            fi

            if [ "$ALL_RESOLVED" != "true" ]; then
              continue
            fi

            # Issue is unblocked - check if it needs triggering
            if echo "$ISSUE_LABELS" | grep -qE "needs-review|ready-for-implementation"; then
              # Has label but no workflow running - re-trigger by cycling the label
              echo "  Has label but no workflow running - re-triggering"
              gh issue edit "$ISSUE_NUM" --repo "${{ github.repository }}" --remove-label "needs-review" 2>/dev/null || true
              gh issue edit "$ISSUE_NUM" --repo "${{ github.repository }}" --remove-label "ready-for-implementation" 2>/dev/null || true
              sleep 1
              gh issue edit "$ISSUE_NUM" --repo "${{ github.repository }}" --add-label "needs-review"
              echo "  ✅ Re-triggered #$ISSUE_NUM"
              exit 0
            else
              # Add needs-review label
              echo "  ✅ All blockers resolved - adding needs-review"
              gh issue edit "$ISSUE_NUM" --repo "${{ github.repository }}" --add-label "needs-review"
              echo "  Triggered #$ISSUE_NUM"
              exit 0
            fi
          done

          echo ""
          echo "=== Summary ==="
          echo "No issues to trigger (all blocked or closed)"
