name: Claude Epic Update

on:
  issues:
    types: [closed]

jobs:
  update-epic:
    # Only run when an issue with an epic label is closed
    if: |
      github.event.issue.state == 'closed' &&
      contains(toJSON(github.event.issue.labels), 'epic:')

    runs-on: ubuntu-latest

    concurrency:
      group: claude-automation
      cancel-in-progress: false

    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get epic info
        id: epic
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Extract epic label
          EPIC_LABEL=$(echo '${{ toJSON(github.event.issue.labels) }}' | jq -r '.[] | select(.name | startswith("epic:")) | .name' | head -1)

          if [ -z "$EPIC_LABEL" ]; then
            echo "No epic label found"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Find the active epic
          EPIC_NUMBER=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "type:epic" \
            --label "status:active" \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -z "$EPIC_NUMBER" ] || [ "$EPIC_NUMBER" = "null" ]; then
            echo "No active epic found"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "epic_number=$EPIC_NUMBER" >> $GITHUB_OUTPUT
          echo "epic_label=$EPIC_LABEL" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Update epic and enforce phase ordering
        if: steps.epic.outputs.skip != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Issue #${{ github.event.issue.number }} ("${{ github.event.issue.title }}") was just closed.
            Epic: #${{ steps.epic.outputs.epic_number }}

            ## Your Tasks

            1. **Check off the completed issue in the epic**
               - Get the epic body: `gh issue view ${{ steps.epic.outputs.epic_number }} --json body --jq '.body'`
               - Replace `- [ ] #${{ github.event.issue.number }}` with `- [x] #${{ github.event.issue.number }}`
               - Update: `gh issue edit ${{ steps.epic.outputs.epic_number }} --body-file /tmp/epic-body.md`

            2. **Analyze phase structure and trigger next issues**
               - Parse the epic markdown to identify phases (### Phase N: ...)
               - Find the FIRST phase that still has unchecked items (`- [ ]`)
               - For each unchecked issue in that phase:
                 - Check if it has a "Blocked by:" section with open blockers
                 - Use `gh issue view ISSUE_NUM --json state` to check blocker status
                 - If ALL blockers are closed (or no blockers), add `needs-review` label
               - Do NOT trigger issues from later phases until current phase is complete

            3. **Post a brief status comment on the epic** (optional, only if you triggered new issues)

            ## Rules
            - Only trigger issues from the FIRST incomplete phase
            - Respect "Blocked by:" dependencies within the phase
            - Use `gh issue edit ISSUE --add-label "needs-review"` to trigger
            - Be concise in any comments

          allowed_tools: Bash,Read,Glob,Grep
          claude_args: '--model claude-sonnet-4-5-20250929 --max-turns 15'
