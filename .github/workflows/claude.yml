name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    # Only allow trusted actors or issues/PRs with claude-approved label
    # Also block bot-authored comments/reviews to prevent self-triggering loops
    if: |
      (
        github.actor == 'andreasronge' ||
        contains(github.event.issue.labels.*.name, 'claude-approved') ||
        contains(github.event.pull_request.labels.*.name, 'claude-approved')
      ) && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude') && github.event.comment.user.type != 'Bot') ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude') && github.event.review.user.type != 'Bot') ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')) && github.event.issue.user.type != 'Bot')
      )
    runs-on: ubuntu-latest

    # Prevent concurrent Claude operations on the same PR/issue
    # All claude-* workflows use the same group naming: claude-pr-{number}
    concurrency:
      group: claude-pr-${{ github.event.issue.number || github.event.pull_request.number }}
      cancel-in-progress: false  # Don't cancel in-progress fixes
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    env:
      MIX_ENV: test

    steps:
      - name: Check PAT availability
        run: |
          if [ -z "${{ secrets.PAT_WORKFLOW_TRIGGER }}" ]; then
            echo "::warning::PAT_WORKFLOW_TRIGGER secret not set - workflow triggers from comments will be disabled"
            echo "::warning::PRs created by this workflow won't trigger CI automatically"
          fi

      # For issue_comment on PRs, we need to checkout the PR branch, not main
      - name: Get PR branch (for issue comments on PRs)
        id: pr-branch
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_DATA=$(gh pr view ${{ github.event.issue.number }} --repo ${{ github.repository }} --json headRefName,headRepository,headRepositoryOwner)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          HEAD_REPO=$(echo "$PR_DATA" | jq -r '.headRepository.name')
          HEAD_OWNER=$(echo "$PR_DATA" | jq -r '.headRepositoryOwner.login')
          echo "head_ref=$HEAD_REF" >> $GITHUB_OUTPUT
          echo "head_repo=$HEAD_OWNER/$HEAD_REPO" >> $GITHUB_OUTPUT
          echo "Found PR branch: $HEAD_REF from $HEAD_OWNER/$HEAD_REPO"

          # Check if this is a fork PR
          REPO_OWNER="${{ github.repository_owner }}"
          if [ "$HEAD_OWNER" != "$REPO_OWNER" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "::warning::PR is from a fork ($HEAD_OWNER/$HEAD_REPO) - cannot push fixes"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip fork PRs with comment
        if: steps.pr-branch.outputs.is_fork == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --repo ${{ github.repository }} --body "⚠️ **Cannot auto-fix fork PRs**

          This PR is from a fork, and the automation cannot push changes to fork branches.

          Please apply the requested changes manually, or the repository maintainer can:
          1. Check out the fork branch locally
          2. Make the changes
          3. Push to the fork (if they have access) or ask the contributor to update"

          echo "::notice::Skipping fork PR - posted explanation comment"
          exit 0

      - name: Checkout repository
        if: steps.pr-branch.outputs.is_fork != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # For PR comments, checkout the PR branch; otherwise default branch
          ref: ${{ steps.pr-branch.outputs.head_ref || github.ref }}
          repository: ${{ steps.pr-branch.outputs.head_repo || github.repository }}

      - name: Install git pre-commit hook
        if: steps.pr-branch.outputs.is_fork != 'true'
        run: |
          cp scripts/pre-commit .git/hooks/pre-commit
          chmod +x .git/hooks/pre-commit
          echo "Installed pre-commit hook"

      - name: Setup Elixir environment
        if: steps.pr-branch.outputs.is_fork != 'true'
        uses: ./.github/actions/setup-elixir

      # Determine if this is a PR or Issue context
      - name: Detect context type
        if: steps.pr-branch.outputs.is_fork != 'true'
        id: context
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "issue_comment" ] && [ -z "${{ github.event.issue.pull_request }}" ]; then
            echo "type=issue" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "type=pr" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number || github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Claude Code
        if: steps.pr-branch.outputs.is_fork != 'true'
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          # Use PAT to allow created PRs/comments to trigger other workflows
          # Falls back to github.token if PAT not available
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          prompt: |
            # Task Instructions

            You are responding to a request tagged with @claude.

            **Context Type**: ${{ steps.context.outputs.type }}
            **Number**: #${{ steps.context.outputs.number }}

            ## The Request

            ```
            ${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}
            ```

            ## Workflow Based on Context Type

            ### If this is an ISSUE (context type = "issue"):
            1. Read the issue AND all comments: `gh issue view ${{ steps.context.outputs.number }} --comments`
            2. Create a new branch: `git checkout -b claude/issue-${{ steps.context.outputs.number }}-$(date +%Y%m%d-%H%M%S)`
            3. Make your changes
            4. Run `mix precommit` - only proceed if it passes
            5. Commit and push in ONE command: `git add -A && git commit -m "fix: ..." && git push -u origin HEAD`
               - IMPORTANT: Always chain commit and push together so push happens immediately after commit
            6. Create a PR: `gh pr create --title "Fix #${{ steps.context.outputs.number }}: [brief description]" --body "Fixes #${{ steps.context.outputs.number }}"`
            7. Post summary on the ISSUE: `gh issue comment ${{ steps.context.outputs.number }} --body "YOUR_SUMMARY"`

            ### If this is a PR (context type = "pr"):
            1. Read the PR with comments: `gh pr view ${{ steps.context.outputs.number }} --comments`
            2. Read review comments: `gh api repos/${{ github.repository }}/pulls/${{ steps.context.outputs.number }}/comments --jq '.[] | {path: .path, line: .line, body: .body}'`
            3. Make your changes on the current branch
            4. Run `mix precommit` - only proceed if it passes
            5. Commit and push in ONE command: `git add -A && git commit -m "fix: ..." && git push`
               - IMPORTANT: Always chain commit and push together so push happens immediately after commit
            6. Post summary on the PR: `gh pr comment ${{ steps.context.outputs.number }} --body "YOUR_SUMMARY"`

            ## Your Task

            Follow the instructions in the request above. Make minimal, focused changes.

            ## After Making Changes

            **IMPORTANT**: Before committing, you MUST run:
            ```bash
            mix precommit
            ```

            This runs formatting, compilation checks, credo, and tests. Only commit if precommit passes.

            If precommit fails:
            1. Fix the issues it identifies
            2. Run `mix precommit` again
            3. Only commit when it passes

            ## REQUIRED: Post a Summary Comment

            Your summary should include:
            - What you found/did
            - Whether changes were committed (and the commit message) or why not
            - Any errors encountered
            - If you created a PR, include the PR URL

            **CRITICAL**: NEVER include the literal text "@claude" in any comments you post.
            This would trigger another workflow run and create an infinite loop.

          # Allow Claude to search/read/edit code and run mix commands
          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          claude_args: '--model claude-haiku-4-5-20251001 --allowed-tools "Read,Edit,Write,Grep,Glob,Bash(mix:*),Bash(git:*),Bash(gh issue:*),Bash(gh pr:*),Bash(mkdir:*)"'

          # Enable full output for debugging
          show_full_output: true
