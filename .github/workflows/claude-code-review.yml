name: Claude Code Review

on:
  pull_request:
    types: [opened, labeled, synchronize]

jobs:
  claude-review:
    # Run when:
    # - PR opened/synced from claude/* branch (auto-review Claude's PRs)
    # - claude-review label is added
    # - PR synced and has claude-review label
    if: |
      github.event.pull_request.changed_files > 0 &&
      (
        (github.event.action == 'opened' && startsWith(github.event.pull_request.head.ref, 'claude/')) ||
        (github.event.action == 'synchronize' && startsWith(github.event.pull_request.head.ref, 'claude/')) ||
        (github.event.action == 'labeled' && github.event.label.name == 'claude-review') ||
        (github.event.action == 'synchronize' && contains(github.event.pull_request.labels.*.name, 'claude-review'))
      )

    runs-on: ubuntu-latest

    # Prevent concurrent Claude operations on the same PR
    # All claude-* workflows use the same group naming: claude-pr-{number}
    concurrency:
      group: claude-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write  # Need write to add labels
      issues: read
      id-token: write
    env:
      MIX_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for merge
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Attempt merge with main
        id: merge-check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch the base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}

          # Attempt merge (don't commit, just check for conflicts)
          if git merge origin/${{ github.event.pull_request.base.ref }} --no-commit --no-ff; then
            echo "merge_ok=true" >> $GITHUB_OUTPUT
            echo "✅ Merge with ${{ github.event.pull_request.base.ref }} successful"
          else
            echo "merge_ok=false" >> $GITHUB_OUTPUT
            echo "❌ Merge conflict detected"

            # Add merge-conflict label
            gh pr edit ${{ github.event.pull_request.number }} --add-label "merge-conflict"

            # Post a comment explaining the situation
            gh pr comment ${{ github.event.pull_request.number }} --body "$(cat <<'EOF'
          ⚠️ **Merge Conflict Detected**

          This PR has conflicts with the base branch and cannot be reviewed until they are resolved.

          Please merge or rebase with the base branch and push the changes. The review will run automatically once the conflicts are resolved.
          EOF
          )"
          fi

      - name: Skip review if merge conflict
        if: steps.merge-check.outputs.merge_ok == 'false'
        run: |
          echo "::notice::Skipping review due to merge conflict"
          exit 0

      - name: Remove merge-conflict label if present
        if: steps.merge-check.outputs.merge_ok == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Remove stale merge-conflict label from previous failed merges
          gh pr edit ${{ github.event.pull_request.number }} \
            --remove-label "merge-conflict" 2>/dev/null || true

      - name: Setup Elixir environment
        if: steps.merge-check.outputs.merge_ok == 'true'
        uses: ./.github/actions/setup-elixir

      - name: Install Claude Code CLI
        if: steps.merge-check.outputs.merge_ok == 'true'
        run: |
          npm install -g @anthropic-ai/claude-code
          claude --version

      - name: Run Claude Code Review
        if: steps.merge-check.outputs.merge_ok == 'true'
        id: claude-review
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # PR Review Task

            **Repository**: ${{ github.repository }}
            **PR Number**: ${{ github.event.pull_request.number }}

            ## Instructions

            1. Read `docs/guidelines/pr-review-guidelines.md` for complete review guidelines
            2. Use `gh pr view ${{ github.event.pull_request.number }}` to see the PR description
            3. Use `gh pr diff ${{ github.event.pull_request.number }}` to see changes
            4. If the PR references an issue (e.g., "Fixes #N"), read it with comments: `gh issue view N --comments`
            5. **Check spec documents**: If the issue references a spec/plan document (e.g., `docs/*-plan.md`),
               read it and verify the implementation matches the spec
            6. Follow the review structure and severity language from the guidelines
            7. Post your review using `gh pr comment ${{ github.event.pull_request.number }} --body "..."`

            **CRITICAL**: Check for in-scope completeness - if the PR establishes a pattern,
            verify it's applied consistently. Flag incomplete work as "MUST FIX", not "consider".

            **CRITICAL**: If the issue references a specification document, verify the implementation
            matches the documented structure (file paths, module names, etc.).

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "WebSearch,WebFetch,Read,Grep,Glob,Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(mix:*),Bash(git:*)"'

          # Enable full output for debugging
          show_full_output: true
