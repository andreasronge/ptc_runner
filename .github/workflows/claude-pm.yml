name: Claude PM

on:
  # Run when PR is merged to main
  pull_request:
    types: [closed]
    branches: [main]

  # Run when an issue becomes ready for implementation
  issues:
    types: [labeled]

  # Manual trigger for testing or recovery
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'next-issue'
        type: choice
        options:
          - next-issue      # Normal: find/create next issue to work on
          - status-only     # Just update STATUS.md, don't create issues
          - reset-stuck     # Reset stuck state and resume

jobs:
  pm:
    # Run on:
    # - Merged PRs (not closed without merge)
    # - Issues labeled 'ready-for-implementation'
    # - Manual trigger
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'issues' && github.event.label.name == 'ready-for-implementation') ||
      github.event_name == 'workflow_dispatch'

    runs-on: ubuntu-latest

    # Prevent concurrent PM operations
    concurrency:
      group: claude-pm
      cancel-in-progress: false

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    env:
      MIX_ENV: test

    steps:
      - name: Check PAT availability
        run: |
          if [ -z "${{ secrets.PAT_WORKFLOW_TRIGGER }}" ]; then
            echo "::warning::PAT_WORKFLOW_TRIGGER secret not set - implementation triggers won't work"
            echo "::warning::@claude comments posted by PM won't trigger the claude.yml workflow"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Check for open PRs
        id: open-prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if there are any open PRs (excluding the just-merged one)
          OPEN_PR_COUNT=$(gh pr list --repo "${{ github.repository }}" --state open --json number | jq length)
          echo "open_pr_count=$OPEN_PR_COUNT" >> $GITHUB_OUTPUT

          if [ "$OPEN_PR_COUNT" -gt 0 ]; then
            echo "::notice::Found $OPEN_PR_COUNT open PR(s) - will skip creating new work"
            OPEN_PRS=$(gh pr list --repo "${{ github.repository }}" --state open --json number,title --jq '.[] | "#\(.number): \(.title)"')
            echo "Open PRs:"
            echo "$OPEN_PRS"
          fi

      - name: Check current PM status
        id: status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Query GitHub directly for PM state (source of truth)

          # Check for stuck state via label
          STUCK_ISSUES=$(gh issue list --repo "${{ github.repository }}" --label "pm-stuck" --state open --json number | jq length)
          if [ "$STUCK_ISSUES" -gt 0 ]; then
            echo "is_stuck=true" >> $GITHUB_OUTPUT
            echo "::warning::PM workflow is in STUCK state (found issue with pm-stuck label)"
          else
            echo "is_stuck=false" >> $GITHUB_OUTPUT
          fi

          # Count recent failures via label (issues that failed PM attempts)
          FAILURE_COUNT=$(gh issue list --repo "${{ github.repository }}" --label "pm-failed-attempt" --state open --json number | jq length)
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FAILURE_COUNT" -ge 3 ]; then
            echo "::warning::$FAILURE_COUNT consecutive PM failures detected"
          fi

      - name: Handle stuck state
        if: steps.status.outputs.is_stuck == 'true' && github.event.inputs.action != 'reset-stuck' && github.event.inputs.action != 'status-only'
        run: |
          echo "::error::PM workflow is stuck. Use workflow_dispatch with 'reset-stuck' action to resume."
          echo "Check issues with 'pm-stuck' label for details on what went wrong."
          exit 1

      - name: Reset stuck state
        if: github.event.inputs.action == 'reset-stuck'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Resetting stuck state..."
          # Remove pm-stuck label from all issues
          for issue in $(gh issue list --label "pm-stuck" --state open --json number --jq '.[].number'); do
            echo "Removing pm-stuck label from issue #$issue"
            gh issue edit "$issue" --remove-label "pm-stuck" || true
          done
          # Remove pm-failed-attempt label from all issues
          for issue in $(gh issue list --label "pm-failed-attempt" --state open --json number --jq '.[].number'); do
            echo "Removing pm-failed-attempt label from issue #$issue"
            gh issue edit "$issue" --remove-label "pm-failed-attempt" || true
          done
          echo "Stuck state reset complete"

      - name: Run Claude PM
        id: claude-pm
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            # Product Manager Workflow

            You are the PM workflow for this repository. Your job is to manage the development pipeline.

            **Repository**: ${{ github.repository }}
            **Trigger**: ${{ github.event_name }}
            **Action**: ${{ github.event.inputs.action || 'next-issue' }}
            **Current failure count**: ${{ steps.status.outputs.failure_count }}
            **Is stuck**: ${{ steps.status.outputs.is_stuck }}
            **Open PRs**: ${{ steps.open-prs.outputs.open_pr_count }}

            ## Read Guidelines First

            Before doing anything, read these documents:
            1. `docs/guidelines/issue-creation-guidelines.md` - How to create issues
            2. `docs/guidelines/planning-guidelines.md` - The 9-point review checklist
            3. `docs/architecture.md` - Implementation phases and what to build

            ## State Management

            **GitHub is the source of truth** - do NOT rely on STATUS.md for state tracking.

            Query state directly:
            - **Work in progress**: `gh pr list --state open` (any open PR = work in progress)
            - **Stuck state**: `gh issue list --label "pm-stuck" --state open`
            - **Failure count**: `gh issue list --label "pm-failed-attempt" --state open`
            - **Ready for work**: `gh issue list --label "ready-for-implementation" --state open`

            ## Your Task Based on Action

            ### If action is "status-only":
            1. Analyze codebase and GitHub state
            2. Report current implementation progress
            3. Do NOT create or trigger any issues
            4. Exit

            ### If action is "reset-stuck":
            The labels have already been removed by the workflow. Just proceed with "next-issue" logic.

            ### If action is "next-issue" (default):

            #### Step 1: Check for Blocking Issues

            ```bash
            # Check for bug issues (highest priority)
            gh issue list --label "bug" --state open --json number,title

            # Check for issues from PR reviews that need fixing
            gh issue list --label "from-pr-review" --state open --json number,title

            # Check for tech debt issues
            gh issue list --label "tech-debt" --state open --json number,title
            ```

            **Priority order:**
            1. `bug` - Bugs should be fixed before new features
            2. `from-pr-review` - Issues found during PR review take priority
            3. `tech-debt` - Technical debt that may block progress

            If there are blocking issues:
            - Evaluate each one: should it be done now, or is there a documented reason to defer?
            - Valid reasons to defer: "will be addressed in issue #X", "low value vs complexity", "needs design decision"
            - If should be done: check if it has `ready-for-implementation`, if not add `needs-review` first
            - If should be deferred: add a comment explaining why, and continue to next step

            #### Step 2: Check for Ready AND Approved Issues

            ```bash
            # Check for issues that are BOTH ready AND approved by maintainer
            gh issue list --label "ready-for-implementation" --label "claude-approved" --state open --json number,title
            ```

            If there's an issue with BOTH labels:
            - Pick the oldest one (or highest priority if labeled)
            - Skip to Step 4 (trigger implementation)

            If NO issue has both labels:
            - Exit with message: "No approved issues ready for implementation. Maintainer must add 'claude-approved' label to issues before PM can work on them."
            - Do NOT create new issues - this workflow does not create issues autonomously

            #### Step 3: Pre-Implementation Check

            Before triggering implementation, evaluate whether the issue can proceed:

            1. **Read the issue and comments**:
               ```bash
               gh issue view ISSUE_NUMBER --comments
               ```

            2. **Check for blockers** - Look for:
               - Comments mentioning "blocked by #N", "waiting for #N", "depends on #N"
               - References to other issues that must be done first
               - If a blocker issue is referenced, check if it's still open:
                 ```bash
                 gh issue view BLOCKER_NUMBER --json state
                 ```

            3. **If blocked by open issue**: Do NOT trigger implementation. Exit and report the blocker.

            4. **Assess implementation readiness** - Briefly consider:
               - Does the codebase need refactoring to implement this cleanly?
               - Should this issue be split into smaller issues?
               - Are there prerequisites not captured in existing issues?

               If you identify a blocker:
               - Add a comment to the ready issue: "Blocked by #N - [brief reason]"
               - **STOP** - Do not trigger implementation (maintainer must resolve the blocker)

            #### Step 4: Trigger Implementation

            When the issue is ready and unblocked:

            Post a comment to trigger the claude.yml workflow:

            ```bash
            gh issue comment ISSUE_NUMBER --body "@claude Please implement this issue:

            1. First, read the review comments on this issue
            2. If the review identified issues (inconsistencies, missing details, etc.), update the issue description to address them
            3. Implement the issue following the (updated) specification
            4. Create a PR with your implementation

            Make sure your implementation addresses any concerns raised in the review."
            ```

            ## Handling Failures

            ### If Implementation Fails

            If the implementation attempt fails or the issue cannot proceed:

            1. Add a comment to the issue explaining what went wrong
            2. Add `pm-failed-attempt` label to track the failure
            3. Exit - the maintainer will need to intervene

            ### STUCK State

            If 3+ issues have `pm-failed-attempt` label, enter STUCK state:

            1. Add `pm-stuck` label to the problematic issue
            2. Post a comment explaining what went wrong
            3. Exit with error

            To recover from stuck state, someone must:
            - Fix the underlying issue
            - Remove the `pm-stuck` label
            - Run the workflow with "reset-stuck" action

            ## Safety Rules

            1. **No issue creation**: This workflow does NOT create issues. Only the maintainer creates issues.
            2. **Require claude-approved**: Only work on issues with BOTH `ready-for-implementation` AND `claude-approved` labels
            3. **One issue at a time**: Never have multiple issues in flight
            4. **Wait for merge**: Don't trigger implementations while a PR is open
               - If Open PRs > 0, exit without taking action
               - This prevents parallel work that could conflict
            5. **Don't skip steps**: Always check blocking issues first

            ## Output

            At the end, summarize what you did:
            - What action was taken
            - What issue was created/triggered (if any)
            - Current state (from GitHub labels/PRs)
            - Any errors or warnings

            Now begin the PM workflow.

          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "WebSearch,WebFetch,Read,Edit,Write,Grep,Glob,Bash(gh issue:*),Bash(gh pr:*),Bash(gh label:*),Bash(git:*),Bash(mix test:*)"'

          show_full_output: true

      - name: Check PM result
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "PM workflow completed"
          echo ""
          echo "Current state:"
          echo "- Open PRs: $(gh pr list --state open --json number | jq length)"
          echo "- Ready issues: $(gh issue list --label ready-for-implementation --state open --json number | jq length)"
          echo "- Stuck: $(gh issue list --label pm-stuck --state open --json number | jq length)"
