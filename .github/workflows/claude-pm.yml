name: Claude PM

on:
  # Run when PR is merged to main
  pull_request:
    types: [closed]
    branches: [main]

  # Run when an issue becomes ready for implementation
  issues:
    types: [labeled]

  # Manual trigger for testing or recovery
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'next-issue'
        type: choice
        options:
          - next-issue      # Normal: find/create next issue to work on
          - status-only     # Just report status, don't create/trigger issues
          - reset-stuck     # Reset stuck state and resume

jobs:
  pm:
    # Run on:
    # - Merged PRs (not closed without merge)
    # - Issues labeled 'ready-for-implementation'
    # - Manual trigger
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'issues' && github.event.label.name == 'ready-for-implementation') ||
      github.event_name == 'workflow_dispatch'

    runs-on: ubuntu-latest

    # Prevent concurrent PM operations
    concurrency:
      group: claude-pm
      cancel-in-progress: false

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    env:
      MIX_ENV: test

    steps:
      - name: Check PAT availability
        run: |
          if [ -z "${{ secrets.PAT_WORKFLOW_TRIGGER }}" ]; then
            echo "::warning::PAT_WORKFLOW_TRIGGER secret not set - implementation triggers won't work"
            echo "::warning::@claude comments posted by PM won't trigger the claude.yml workflow"
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Setup Claude Code
        uses: ./.github/actions/setup-claude-code

      - name: Check for open PRs
        id: open-prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if there are any open PRs (excluding the just-merged one)
          OPEN_PR_COUNT=$(gh pr list --repo "${{ github.repository }}" --state open --json number | jq length)
          echo "open_pr_count=$OPEN_PR_COUNT" >> $GITHUB_OUTPUT

          if [ "$OPEN_PR_COUNT" -gt 0 ]; then
            echo "::notice::Found $OPEN_PR_COUNT open PR(s) - will skip creating new work"
            OPEN_PRS=$(gh pr list --repo "${{ github.repository }}" --state open --json number,title --jq '.[] | "#\(.number): \(.title)"')
            echo "Open PRs:"
            echo "$OPEN_PRS"
          fi

      - name: Check current PM status
        id: status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Query GitHub directly for PM state (source of truth)

          # Check for stuck state via label
          STUCK_ISSUES=$(gh issue list --repo "${{ github.repository }}" --label "pm-stuck" --state open --json number | jq length)
          if [ "$STUCK_ISSUES" -gt 0 ]; then
            echo "is_stuck=true" >> $GITHUB_OUTPUT
            echo "::warning::PM workflow is in STUCK state (found issue with pm-stuck label)"
          else
            echo "is_stuck=false" >> $GITHUB_OUTPUT
          fi

          # Count recent failures via label (issues that failed PM attempts)
          FAILURE_COUNT=$(gh issue list --repo "${{ github.repository }}" --label "pm-failed-attempt" --state open --json number | jq length)
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FAILURE_COUNT" -ge 3 ]; then
            echo "::warning::$FAILURE_COUNT consecutive PM failures detected"
          fi

      - name: Handle stuck state
        if: steps.status.outputs.is_stuck == 'true' && github.event.inputs.action != 'reset-stuck' && github.event.inputs.action != 'status-only'
        run: |
          echo "::error::PM workflow is stuck. Use workflow_dispatch with 'reset-stuck' action to resume."
          echo "Check issues with 'pm-stuck' label for details on what went wrong."
          exit 1

      - name: Reset stuck state
        if: github.event.inputs.action == 'reset-stuck'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Resetting stuck state..."
          # Remove pm-stuck label from all issues
          for issue in $(gh issue list --label "pm-stuck" --state open --json number --jq '.[].number'); do
            echo "Removing pm-stuck label from issue #$issue"
            gh issue edit "$issue" --remove-label "pm-stuck" || true
          done
          # Remove pm-failed-attempt label from all issues
          for issue in $(gh issue list --label "pm-failed-attempt" --state open --json number --jq '.[].number'); do
            echo "Removing pm-failed-attempt label from issue #$issue"
            gh issue edit "$issue" --remove-label "pm-failed-attempt" || true
          done
          echo "Stuck state reset complete"

      - name: Find active epic
        id: epic
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find active epic (source of truth for PM workflow)
          EPIC_DATA=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "type:epic" \
            --label "status:active" \
            --state open \
            --json number,title,body \
            --limit 1)

          EPIC_COUNT=$(echo "$EPIC_DATA" | jq length)

          if [ "$EPIC_COUNT" -eq 0 ]; then
            echo "has_epic=false" >> $GITHUB_OUTPUT
            echo "::notice::No active epic found - PM will handle other work"
          else
            echo "has_epic=true" >> $GITHUB_OUTPUT
            EPIC_NUMBER=$(echo "$EPIC_DATA" | jq -r '.[0].number')
            EPIC_TITLE=$(echo "$EPIC_DATA" | jq -r '.[0].title')

            echo "number=$EPIC_NUMBER" >> $GITHUB_OUTPUT
            # Use EOF delimiter to handle titles with special characters
            echo "title<<EPIC_TITLE_EOF" >> $GITHUB_OUTPUT
            echo "$EPIC_TITLE" >> $GITHUB_OUTPUT
            echo "EPIC_TITLE_EOF" >> $GITHUB_OUTPUT

            # Write body to file for multi-line handling
            echo "$EPIC_DATA" | jq -r '.[0].body' > /tmp/epic-body.md

            echo "Found active epic #$EPIC_NUMBER: $EPIC_TITLE"
          fi

          # Tech debt / from-pr-review count (PM monitors these regardless of epic)
          tech_debt=$(gh issue list --label "from-pr-review" --state open --json number | jq length)
          echo "tech_debt=$tech_debt" >> $GITHUB_OUTPUT

          # Ready for implementation count
          ready_issues=$(gh issue list --label "ready-for-implementation" --state open --json number | jq length)
          echo "ready_issues=$ready_issues" >> $GITHUB_OUTPUT

          # Needs review count (pending review)
          needs_review=$(gh issue list --label "needs-review" --state open --json number | jq length)
          echo "needs_review=$needs_review" >> $GITHUB_OUTPUT

          echo "Status:"
          echo "  Tech debt: $tech_debt"
          echo "  Ready issues: $ready_issues"
          echo "  Needs review: $needs_review"

      - name: Read epic body
        id: epic-body
        if: steps.epic.outputs.has_epic == 'true'
        run: |
          # Use delimiter to handle multi-line content
          echo "body<<EPIC_BODY_EOF" >> $GITHUB_OUTPUT
          cat /tmp/epic-body.md >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EPIC_BODY_EOF" >> $GITHUB_OUTPUT

      - name: Run Claude PM
        id: claude-pm
        # Skip if there are open PRs (unless status-only which is read-only)
        if: steps.open-prs.outputs.open_pr_count == '0' || github.event.inputs.action == 'status-only'
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          path_to_claude_code_executable: /home/runner/.local/bin/claude
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            /pm-workflow **Repository**: ${{ github.repository }}
            **Trigger**: ${{ github.event_name }}
            **Action**: ${{ github.event.inputs.action || 'next-issue' }}

            ## Epic Status
            - **Has active epic**: ${{ steps.epic.outputs.has_epic }}
            - **Epic number**: #${{ steps.epic.outputs.number || 'N/A' }}
            - **Epic title**: ${{ steps.epic.outputs.title || 'N/A' }}

            ## Epic Body
            ${{ steps.epic-body.outputs.body || '*No active epic - handle tech debt and ready issues*' }}

            ## Other Work
            - **Ready for implementation**: ${{ steps.epic.outputs.ready_issues }}
            - **Pending review**: ${{ steps.epic.outputs.needs_review }}
            - **Tech debt (from-pr-review)**: ${{ steps.epic.outputs.tech_debt }}
            - **Failure count**: ${{ steps.status.outputs.failure_count }}

          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "Read,Write,Edit,MultiEdit,Glob,Grep,LS,Bash,WebSearch,WebFetch,Task,TodoWrite,TodoRead"'

          show_full_output: true

      - name: Check PM result
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "PM workflow completed"
          echo ""
          echo "Current state:"
          echo "- Open PRs: $(gh pr list --state open --json number | jq length)"
          echo "- Ready issues: $(gh issue list --label ready-for-implementation --state open --json number | jq length)"
          echo "- Stuck: $(gh issue list --label pm-stuck --state open --json number | jq length)"
          echo ""
          echo "Epic status:"
          EPIC=$(gh issue list --label "type:epic" --label "status:active" --state open --json number,title --limit 1)
          if [ "$(echo "$EPIC" | jq length)" -gt 0 ]; then
            echo "- Active epic: #$(echo "$EPIC" | jq -r '.[0].number') - $(echo "$EPIC" | jq -r '.[0].title')"
          else
            echo "- Active epic: None"
          fi
          echo ""
          echo "Work queues:"
          echo "- Tech debt (from-pr-review): $(gh issue list --label from-pr-review --state open --json number | jq length)"
          echo "- Needs review: $(gh issue list --label needs-review --state open --json number | jq length)"
          echo "- Deferred: $(gh issue list --label deferred --state open --json number | jq length)"
