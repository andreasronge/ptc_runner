name: Claude PM

on:
  pull_request:
    types: [closed]
    branches: [main]

  issues:
    types: [closed, labeled]

  workflow_dispatch:

jobs:
  pm:
    # Run on: schedule, manual, merged PRs, closed issues, or relevant labels
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      (github.event_name == 'issues' && github.event.action == 'closed') ||
      (github.event_name == 'issues' && github.event.action == 'labeled' && contains(fromJSON('["ready-for-implementation", "needs-clarification", "needs-breakdown", "from-pr-review"]'), github.event.label.name))

    runs-on: ubuntu-latest

    concurrency:
      group: claude-automation
      cancel-in-progress: false

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    env:
      MIX_ENV: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}

      - name: Setup Elixir environment
        uses: ./.github/actions/setup-elixir

      - name: Setup Claude Code
        id: setup-claude
        uses: ./.github/actions/setup-claude-code

      - name: Check for open PRs
        id: open-prs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check if there are any open PRs (excluding the just-merged one)
          OPEN_PR_COUNT=$(gh pr list --repo "${{ github.repository }}" --state open --json number | jq length)
          echo "count=$OPEN_PR_COUNT" >> $GITHUB_OUTPUT

          # Get detailed PR info for Claude context
          gh pr list --repo "${{ github.repository }}" --state open \
            --json number,title,headRefName,labels,updatedAt \
            --jq '.[] | "- #\(.number): \(.title) (branch: \(.headRefName), labels: \([.labels[].name] | join(", ")), updated: \(.updatedAt))"' \
            > /tmp/open-prs.txt

          if [ "$OPEN_PR_COUNT" -gt 0 ]; then
            echo "::notice::Found $OPEN_PR_COUNT open PR(s) - will skip creating new work"
            echo "Open PRs:"
            cat /tmp/open-prs.txt
          else
            echo "No open PRs" > /tmp/open-prs.txt
          fi

      - name: Check running workflows
        id: workflows
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Check for running Claude workflows
          IMPL_RUNNING=$(gh run list --repo "${{ github.repository }}" --workflow=claude-issue.yml --status=in_progress --json databaseId --jq 'length')
          REVIEW_RUNNING=$(gh run list --repo "${{ github.repository }}" --workflow=claude-issue-review.yml --status=in_progress --json databaseId --jq 'length')
          PR_FIX_RUNNING=$(gh run list --repo "${{ github.repository }}" --workflow=claude-pr-fix.yml --status=in_progress --json databaseId --jq 'length')

          echo "implementation=$IMPL_RUNNING" >> $GITHUB_OUTPUT
          echo "review=$REVIEW_RUNNING" >> $GITHUB_OUTPUT
          echo "pr_fix=$PR_FIX_RUNNING" >> $GITHUB_OUTPUT

          echo "Running workflows:"
          echo "- Implementation: $IMPL_RUNNING"
          echo "- Review: $REVIEW_RUNNING"
          echo "- PR Fix: $PR_FIX_RUNNING"

      - name: Check current PM status
        id: status
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Query GitHub directly for PM state (source of truth)

          # Check for stuck state via label
          STUCK_ISSUES=$(gh issue list --repo "${{ github.repository }}" --label "pm-stuck" --state open --json number | jq length)
          if [ "$STUCK_ISSUES" -gt 0 ]; then
            echo "is_stuck=true" >> $GITHUB_OUTPUT
            echo "::warning::PM workflow is in STUCK state (found issue with pm-stuck label)"
          else
            echo "is_stuck=false" >> $GITHUB_OUTPUT
          fi

          # Count recent failures via label (issues that failed PM attempts)
          FAILURE_COUNT=$(gh issue list --repo "${{ github.repository }}" --label "pm-failed-attempt" --state open --json number | jq length)
          echo "failure_count=$FAILURE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FAILURE_COUNT" -ge 3 ]; then
            echo "::warning::$FAILURE_COUNT consecutive PM failures detected"
          fi

      - name: Handle stuck state
        if: steps.status.outputs.is_stuck == 'true'
        run: |
          echo "::error::PM workflow is stuck. Use workflow_dispatch with 'reset-stuck' action to resume."
          echo "Check issues with 'pm-stuck' label for details on what went wrong."
          exit 1

      - name: Reset stuck state
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Resetting stuck state..."
          # Remove pm-stuck label from all issues
          for issue in $(gh issue list --label "pm-stuck" --state open --json number --jq '.[].number'); do
            echo "Removing pm-stuck label from issue #$issue"
            gh issue edit "$issue" --remove-label "pm-stuck" || true
          done
          # Remove pm-failed-attempt label from all issues
          for issue in $(gh issue list --label "pm-failed-attempt" --state open --json number --jq '.[].number'); do
            echo "Removing pm-failed-attempt label from issue #$issue"
            gh issue edit "$issue" --remove-label "pm-failed-attempt" || true
          done
          echo "Stuck state reset complete"

      - name: Find active epic
        id: epic
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find active epic (source of truth for PM workflow)
          EPIC_DATA=$(gh issue list \
            --repo "${{ github.repository }}" \
            --label "type:epic" \
            --label "status:active" \
            --state open \
            --json number,title,body \
            --limit 1)

          EPIC_COUNT=$(echo "$EPIC_DATA" | jq length)

          if [ "$EPIC_COUNT" -eq 0 ]; then
            echo "has_epic=false" >> $GITHUB_OUTPUT
            echo "::notice::No active epic found - PM will handle other work"
          else
            echo "has_epic=true" >> $GITHUB_OUTPUT
            EPIC_NUMBER=$(echo "$EPIC_DATA" | jq -r '.[0].number')
            EPIC_TITLE=$(echo "$EPIC_DATA" | jq -r '.[0].title')

            echo "number=$EPIC_NUMBER" >> $GITHUB_OUTPUT
            # Use EOF delimiter to handle titles with special characters
            echo "title<<EPIC_TITLE_EOF" >> $GITHUB_OUTPUT
            echo "$EPIC_TITLE" >> $GITHUB_OUTPUT
            echo "EPIC_TITLE_EOF" >> $GITHUB_OUTPUT

            # Write body to file for multi-line handling
            echo "$EPIC_DATA" | jq -r '.[0].body' > /tmp/epic-body.md

            echo "Found active epic #$EPIC_NUMBER: $EPIC_TITLE"
          fi

          # Tech debt / from-pr-review count (PM monitors these regardless of epic)
          # Exclude quick-fix issues - they're handled by batch-fix workflow
          tech_debt=$(gh issue list --label "from-pr-review" --state open --json number,labels \
            | jq '[.[] | select(.labels | map(.name) | index("quick-fix") | not)] | length')
          echo "tech_debt=$tech_debt" >> $GITHUB_OUTPUT

          # Quick-fix count (for awareness, handled by batch-fix workflow)
          quick_fix=$(gh issue list --label "quick-fix" --state open --json number | jq length)
          echo "quick_fix=$quick_fix" >> $GITHUB_OUTPUT

          # Ready for implementation count
          ready_issues=$(gh issue list --label "ready-for-implementation" --state open --json number | jq length)
          echo "ready_issues=$ready_issues" >> $GITHUB_OUTPUT

          # Needs review count (pending review)
          needs_review=$(gh issue list --label "needs-review" --state open --json number | jq length)
          echo "needs_review=$needs_review" >> $GITHUB_OUTPUT

          echo "Status:"
          echo "  Tech debt: $tech_debt"
          echo "  Quick-fix: $quick_fix (handled by batch-fix workflow)"
          echo "  Ready issues: $ready_issues"
          echo "  Needs review: $needs_review"

      - name: Read epic body
        id: epic-body
        if: steps.epic.outputs.has_epic == 'true'
        run: |
          # Use delimiter to handle multi-line content
          echo "body<<EPIC_BODY_EOF" >> $GITHUB_OUTPUT
          cat /tmp/epic-body.md >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EPIC_BODY_EOF" >> $GITHUB_OUTPUT

      - name: Run Claude PM
        id: claude-pm
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_WORKFLOW_TRIGGER || github.token }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          path_to_claude_code_executable: ${{ steps.setup-claude.outputs.executable-path }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            You are the PM agent. Keep this project moving forward.

            **Trigger**: ${{ github.event_name }}
            **Epic**: #${{ steps.epic.outputs.number || 'None' }} ${{ steps.epic.outputs.title || '' }}
            **Tech debt**: ${{ steps.epic.outputs.tech_debt }} | **Quick-fix**: ${{ steps.epic.outputs.quick_fix }} (ignore) | **Ready**: ${{ steps.epic.outputs.ready_issues }} | **Needs review**: ${{ steps.epic.outputs.needs_review }}

            **Running workflows**: Implementation: ${{ steps.workflows.outputs.implementation }} | Review: ${{ steps.workflows.outputs.review }} | PR Fix: ${{ steps.workflows.outputs.pr_fix }}

            **Open PRs** (${{ steps.open-prs.outputs.count }}):
            $(cat /tmp/open-prs.txt)

            **Gather context:**
            - `gh issue list --state open --json number,title,labels --limit 30` (then filter out quick-fix)
            - `gh issue list --label from-pr-review --state open` (priority, exclude quick-fix)
            - `gh issue list --label needs-clarification,needs-breakdown --state open` (stuck)

            **IGNORE**: Issues with `quick-fix` label - handled by batch-fix workflow separately.

            **Priorities:** tech debt (`from-pr-review`, non-quick-fix) > stuck reviews > stuck implementations > next epic task

            **Your job:** Find the highest-priority item and take ONE action to move it forward.

            **Rules:**
            - ONE action per run
            - After 3 failed attempts on same issue, add `needs-human-review` and move on
            - If nothing needs attention, report status and exit
            - **Open PRs (${{ steps.open-prs.outputs.count }})**: If >0, do bookkeeping only (update epic checkboxes, handle tech debt) but do NOT create new issues or queue new work

            **Issue workflow (MUST follow this order):**
            1. New issue without `needs-review` or `ready-for-implementation` → add `needs-review` label
            2. Issue with `needs-review` → wait for review workflow (do nothing)
            3. Issue with `ready-for-implementation` → trigger implementation with `@claude` comment

            **NEVER skip review**: Do NOT post `@claude` on issues that don't have `ready-for-implementation` label.

            **Unsticking issues:**
            - If issue has `ready-for-implementation` but no running implementation workflow and no recent `@claude` comment, re-trigger: `gh issue comment ISSUE --body "@claude Please implement this issue."`
            - If issue has `needs-review` but review workflow not running and no `ready-for-implementation`, remove and re-add label to trigger review
            - Check branch names in open PRs to see which issues have work in progress (e.g., `claude/issue-123-...`)

            **Guidelines:** `docs/guidelines/planning-guidelines.md`, `docs/guidelines/issue-creation-guidelines.md`, `docs/guidelines/github-workflows.md`

          claude_args: '--model claude-sonnet-4-5-20250929 --max-turns 50 --allowed-tools "Read,Write,Edit,Glob,Grep,Bash,Task,TodoWrite,TodoRead"'
          show_full_output: true

      - name: Check PM result
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "PM workflow completed"
          echo ""
          echo "Current state:"
          echo "- Open PRs: $(gh pr list --state open --json number | jq length)"
          echo "- Ready issues: $(gh issue list --label ready-for-implementation --state open --json number | jq length)"
          echo "- Stuck: $(gh issue list --label pm-stuck --state open --json number | jq length)"
          echo ""
          echo "Epic status:"
          EPIC=$(gh issue list --label "type:epic" --label "status:active" --state open --json number,title --limit 1)
          if [ "$(echo "$EPIC" | jq length)" -gt 0 ]; then
            echo "- Active epic: #$(echo "$EPIC" | jq -r '.[0].number') - $(echo "$EPIC" | jq -r '.[0].title')"
          else
            echo "- Active epic: None"
          fi
          echo ""
          echo "Work queues:"
          echo "- Tech debt (from-pr-review): $(gh issue list --label from-pr-review --state open --json number | jq length)"
          echo "- Needs review: $(gh issue list --label needs-review --state open --json number | jq length)"
          echo "- Deferred: $(gh issue list --label deferred --state open --json number | jq length)"
