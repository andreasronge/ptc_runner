#!/bin/bash

set -e

echo "üîç Running pre-push checks..."

# Track time
START_TIME=$(date +%s)

# 1. Run full test suite
echo "  ‚è≥ Running full test suite..."
if ! mix test --exclude clojure 2>&1; then
  echo "  ‚ùå Tests failed. Run: mix test"
  exit 1
fi
echo "  ‚úÖ Tests passed"

# 2. Run dialyzer
echo "  ‚è≥ Running dialyzer (this may take a moment)..."
DIALYZER_OUTPUT=$(mix dialyzer 2>&1)
DIALYZER_EXIT=$?

if [ $DIALYZER_EXIT -ne 0 ]; then
  echo "  ‚ùå Dialyzer found errors:"
  echo "$DIALYZER_OUTPUT"
  echo ""
  echo "  Run: mix dialyzer"
  exit 1
fi
echo "  ‚úÖ Dialyzer passed"

# Calculate elapsed time
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo ""
echo "‚úÖ All pre-push checks passed in ${ELAPSED}s"
echo ""
